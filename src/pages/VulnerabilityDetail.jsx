import React, { useEffect, useState, useRef } from 'react'
import { useParams } from 'react-router-dom'
import { fetchVulnById } from '../api/mockApi'
import html2pdf from 'html2pdf.js'

export default function VulnerabilityDetail(){
  const { id } = useParams()
  const [v, setV] = useState(null)
  const ref = useRef()

  useEffect(()=> {
    fetchVulnById(id).then(setV)
  },[id])

  if(!v) return <div className="card">Loading vulnerability...</div>

  function exportPDF(){
    const opt = { margin: 0.5, filename: `${v.id}.pdf`, html2canvas: { scale: 2 } }
    html2pdf().set(opt).from(ref.current).save()
  }

  return (
    <div className="max-w-3xl mx-auto">
      <div ref={ref} className="card">
        <h2 className="text-xl font-semibold">{v.type} â€” {v.url}</h2>
        <p className="mt-2"><strong>Parameter:</strong> {v.parameter}</p>
        <p className="mt-1"><strong>Payload:</strong> <code>{v.payload}</code></p>
        <p className="mt-1"><strong>ML Confidence:</strong> {v.mlConfidence}</p>

        <h3 className="mt-3">Example Request</h3>
        <pre>{v.request}</pre>

        <h3 className="mt-3">Example Response</h3>
        <pre>{v.response}</pre>

        <h3 className="mt-3">Suggested Mitigation</h3>
        <p>{v.mitigation}</p>
      </div>

      <div className="mt-4">
        <button onClick={exportPDF} className="px-4 py-2 bg-accent text-white rounded">Export this Section as PDF</button>
      </div>
    </div>
  )
}
